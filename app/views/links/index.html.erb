<link rel="stylesheet" href="//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.9.1.js"></script>
<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>

<script type="text/javascript">

    var map;
    var infowindow = null;

    var rendererOptions = {
        strokeColor: "#FF0000",
        //draggable: true,
        preserveViewport: true,
        suppressMarkers: true
    };

    function initialize() {
        var mapOptions = {
            zoom: 18,
            center: new google.maps.LatLng(37.508059, 375.082752)
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        addMarker();

        addLink();
    }

    function addMarker() {
        var icon = { anchor: new google.maps.Point(11, 11), url: "http://load.my-azur.de/f/o/dot-red.png"};
        <% @nodos.each do |itm| %>
            var coord = new google.maps.LatLng(<%= itm.lat %>, <%= itm.lng %>);
            var title = '<%= itm.id %>';
            var marker = new google.maps.Marker({
                map: map,
                title: title,
                position: coord,
                icon: icon
            });
            map.setCenter(coord);

            infowindow = new google.maps.InfoWindow({
                content: '<span class="infowin"><%= itm.id %></span>'
            });
            google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<span class="infowin"><%= itm.id %></span>');
                infowindow.open(map, this);
            });
        <% end %>
    }

    function addLink() {
        <% @links.each do |itm| %>
            var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
            var directionsService = new google.maps.DirectionsService();
            <% @n1 = Nodo.find(itm.n1) %>
            <% @n2 = Nodo.find(itm.n2) %>
            <% @id = itm.id %>
            var start = new google.maps.LatLng(<%= @n1.lat %>, <%= @n1.lng %>);
            var end = new google.maps.LatLng(<%= @n2.lat %>, <%= @n2.lng %>)

            calcRoute(start, end, directionsService, directionsDisplay);
        <% end %>
    }

    function calcRoute(start, end, dS, dD) {
         dD.setMap(map);

         var request = {
             origin:start,
             destination:end,
             travelMode: google.maps.TravelMode.DRIVING
         };

         dS.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                 dD.setDirections(response);

                google.maps.event.addListener(response, 'click', function () {
                    alert("c9a");
                });

                google.maps.event.addListener(dS, 'click', function () {
                    alert("c9a");
                });
            }
         });
    }

    google.maps.event.addDomListener(window, 'load', initialize);

</script>

<div data-role="header" data-theme="b">
  <h1>Links</h1>
  <div id="custom-border-radius" class="ui-btn-left" data-role="controlgroup" data-type="horizontal" data-mini="true">
    <%= link_to 'Back', 'intloc', 'data-icon' => 'back', 'data-role' => 'button', 'data-iconpos' => 'notext' %>
    <%= link_to 'Home', root_url, 'data-icon' => 'home', 'data-role' => 'button', 'data-iconpos' => 'notext', :target => '_parent' %>
  </div>
  <%= link_to 'Add', new_link_path, 'data-iconpos' => 'notext', 'data-icon' => 'plus', 'class' => 'ui-btn-right', :target => '_parent' %>
</div>

<div data-role="content">
  <div id="map-canvas" style="width: 100%; height: 630px" class="ui-corner-all"></div>
</div>