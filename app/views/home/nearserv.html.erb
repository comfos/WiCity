<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=geometry&sensor=false"></script>

<script type="text/javascript">

    var map;
    var geocoder;
    var mypos = 0;

    var circle;

    var markers = [];

    var intervall = window.setInterval(checkpos, 2000);

    function checkpos() {
        if(mypos == 0)
            preinit();
    }

    function preinit() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                mypos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                window.clearInterval(intervall);
                initialize();
            }, function() {
                handleNoGeolocation(true);
            });
        } else {
            handleNoGeolocation(false);
        }
    }

    function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
            alert("Error: The Geolocation service failed.");
        } else {
            alert("Error: Your browser doesn\'t support geolocation.");
        }
    }

    function initialize() {
        geocoder = new google.maps.Geocoder();

        if(!mypos) {
            mypos = new google.maps.LatLng(37.508059, 375.082752);
        }

        var mapOptions = {
            center: mypos,
            zoom: 14,
            minZoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

        var icon = '/assets/marker/mypos.png';
        markerCenter = new google.maps.Marker({
            position: mypos,
            map: map,
            draggable: true,
            icon: icon
        });

        circle = new google.maps.Circle({
            strokeColor: '#FF0000',
            clickable: false,
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: mypos,
            radius: 1000
        });
        circle.bindTo('center', markerCenter, 'position');

        google.maps.event.addListener(markerCenter, 'dragend', function() {
            mypos = new google.maps.LatLng(markerCenter.position.lat(), markerCenter.position.lng());
            removeMarker();
            addMarker();
        });

        addMarker();
    }

    function removeMarker() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
    }

    function addMarker() {
        var bounds = circle.getBounds();
        var i = 0;
        <% @pharms.each do |pharm| %>
            var coord = new google.maps.LatLng(<%= pharm.lat %>, <%= pharm.lng %>);
            if( bounds.contains(coord) ) {
                var icon = '/assets/marker/pharm.png';
                var marker = new google.maps.Marker({
                    position: coord,
                    map: map,
                    icon: icon,
                    title: '<%= pharm.name %>'
                });
                markers[i] = marker;
                i++;
            }
        <% end %>
    }

    google.maps.event.addDomListener(window, 'load', preinit);
    google.maps.event.addDomListener(window, 'load', initialize);

</script>


<div data-role="header">
  <h1>Nearest Services</h1>
  <%= link_to 'Home', root_url, 'data-icon' => 'home', 'class' => 'ui-btn-left' %>
</div>

<div data-role="content">

  <div class="ui-bar ui-bar-c ui-corner-all ui-shadow">
    <div id="map-canvas" style="width: 100%; height: 100%; min-height: 500px;" class="ui-corner-all ui-shadow"></div>
  </div>

</div>