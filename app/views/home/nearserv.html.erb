<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=geometry&sensor=true"></script>

<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclusterer/1.0/src/markerclusterer_packed.js"></script>

<script type="text/javascript">

    /*var styles = [ [{
        url: '/assets/marker/pharm.png',
        height: 35,
        width: 35,
        opt_anchor: [16, 0],
        opt_textColor: '#000000',
        opt_textSize: 10
    }, {
        url: '../images/people45.png',
        height: 45,
        width: 45,
        opt_anchor: [24, 0],
        opt_textColor: '#ff0000',
        opt_textSize: 11
    }, {
        url: '../images/people55.png',
        height: 55,
        width: 55,
        opt_anchor: [32, 0],
        opt_textSize: 12
    }] ];*/

    var map;
    var geocoder;
    var mypos = 0;

    var circle;

    var infowindow = null;
    var markers_pharms = [];

    var markerClusterer_pharm = null;

    var intervall = window.setInterval(checkpos, 2000);

    function checkpos() {
        if(mypos == 0)
            preinit();
    }

    function updateRadius(circle, rad){
        circle.setRadius(rad*1);
        removeMarker();
        clearClusters();
        addMarker();
    }

    function preinit() {
        var lat = "<%= params[:lat] %>";
        var lng = "<%= params[:lng] %>";
        mypos = new google.maps.LatLng(lat, lng);
        if(!lat) {
            mypos = 0;
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    mypos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    window.clearInterval(intervall);
                    //initialize();
                }, function() {
                    handleNoGeolocation(true);
                });
            } else {
                handleNoGeolocation(false);
            }
        }
    }

    function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
            alert("Error: The Geolocation service failed.");
        } else {
            alert("Error: Your browser doesn\'t support geolocation.");
        }
    }

    function initialize() {
        choice();

        geocoder = new google.maps.Geocoder();

        if(!mypos) {
            mypos = new google.maps.LatLng(37.508059, 375.082752);
        }

        var mapOptions = {
            center: mypos,
            zoom: 14,
            minZoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

        var icon = '/assets/marker/mypos.png';
        var markerCenter = new google.maps.Marker({
            position: mypos,
            map: map,
            draggable: true,
            icon: icon
        });

        circle = new google.maps.Circle({
            strokeColor: '#FF0000',
            clickable: false,
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: mypos,
            radius: 1000
        });
        circle.bindTo('center', markerCenter, 'position');

        $("#slider").on( 'slidestop', function( event, ui ) {
            updateRadius(circle, $("#slider").val());
        });

        google.maps.event.addListener(markerCenter, 'dragend', function() {
            mypos = new google.maps.LatLng(markerCenter.position.lat(), markerCenter.position.lng());
            removeMarker();
            clearClusters();
            addMarker();
        });

        addMarker();
    }

    function removeMarker() {
        for (var i = 0; i < markers_pharms.length; i++) {
            markers_pharms[i].setMap(null);
        }
        markers_pharms = [];
    }

    function addMarker() {
        var bounds = circle.getBounds();
        var marker;
        var i=0;
        if(cpharm) {
            <% @pharms.each do |pharm| %>
                var coord = new google.maps.LatLng(<%= pharm.lat %>, <%= pharm.lng %>);
                if( bounds.contains(coord) ) {
                    var icon = '/assets/marker/pharm.png';
                    marker = new google.maps.Marker({
                        position: coord,
                        map: map,
                        icon: icon,
                        title: '<%= pharm.name %>'
                        });
                    infowindow = new google.maps.InfoWindow({
                            content: '<span class="infowin"><%= pharm.name %></span>'
                    });
                    google.maps.event.addListener(marker, 'click', function () {
                        infowindow.setContent('<a href="<%= "#{pharms_url}/#{pharm.id}" %>?coord='+mypos+'" target="_parent"><%= pharm.name %></a>');
                        //infowindow.setContent('<%= link_to pharm.name, "#{pharms_url}/#{pharm.id}", :target => '_parent', :coord => 'ciao' %>');
                        infowindow.open(map, this);
                    });
                    markers_pharms[i] = marker;
                    i++;
                }
            <% end %>
            /*markerClusterer_pharm = new MarkerClusterer(map, markers_pharms, {
             styles: styles[0]
             });*/
            markerClusterer_pharm = new MarkerClusterer(map, markers_pharms);
        }
    }

    function clearClusters() {
        markerClusterer_pharm.clearMarkers();
    }

    google.maps.event.addDomListener(window, 'load', preinit);
    google.maps.event.addDomListener(window, 'load', initialize);

    function choice() {
        var pharm = document.getElementById("pharm");
        google.maps.event.addDomListener(pharm, 'click', choiceElement);
    }

    var cpharm = true;
    function choiceElement() {
        if(cpharm) {
            $("#pharm").fadeTo( "slow", 0.30 );
            cpharm = false;
        } else {
            $("#pharm").fadeTo( "slow", 1 );
            cpharm = true;
        }
        removeMarker();
        clearClusters();
        addMarker();
    }

</script>


<div data-role="header">
  <h1>Nearest Services</h1>
  <%= link_to 'Home', root_url, 'data-icon' => 'home', 'class' => 'ui-btn-left' %>
</div>

<div data-role="content">

  <a href="#" id="pharm"><img src="assets/marker/pharm.png"/></a>

  <input name="slider" id="slider" min="100" max="5000" value="1000" data-popup-enabled="true" type="range">

  <div class="ui-bar ui-bar-c ui-corner-all ui-shadow" style="padding: 2px">
    <div id="map-canvas" style="height: 100%; min-height: 450px;" class="ui-corner-all ui-shadow"></div>
  </div>

</div>