<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>

<script type="text/javascript">

    var map;
    var geocoder;
    var mypos = 0;

    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();

    var stepDisplay;
    var markerArray = [];

    var intervall = window.setInterval(checkpos, 2000);

    function checkpos() {
        if(mypos == 0)
            preinit();
    }

    function preinit() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                mypos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                window.clearInterval(intervall);
                //initialize();
            }, function() {
                handleNoGeolocation(true);
            });
        } else {
            handleNoGeolocation(false);
        }
    }

    function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
            alert("Error: The Geolocation service failed.");
        } else {
            alert("Error: Your browser doesn\'t support geolocation.");
        }
    }

    function initialize() {
        geocoder = new google.maps.Geocoder();
        directionsDisplay = new google.maps.DirectionsRenderer();

        var mapOptions = {
            center: new google.maps.LatLng(-34.397, 150.644),
            zoom: 17,
            minZoom: 12,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        directionsDisplay.setMap(map);

        directionsDisplay.setPanel(document.getElementById('directions-panel'));
        $( "#directions-panel" ).trigger( "updatelayout" );

        stepDisplay = new google.maps.InfoWindow();

        codeAddress();
    }

    function codeAddress() {
        var address = "<%= @pharm.address %>";
        geocoder.geocode( { 'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                var icon = '/assets/marker/pharm.png';
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    icon: icon
                });
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }

    function calcRoute(mode) {

        for (var i = 0; i < markerArray.length; i++) {
            markerArray[i].setMap(null);
        }

        var selectedMode = mode;
        var request = {
            origin: mypos,
            destination: "<%= @pharm.address %>",
            travelMode: google.maps.TravelMode[selectedMode]
        };
        directionsService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                showSteps(response);
            }
        });
    }

    function showSteps(directionResult) {
        var myRoute = directionResult.routes[0].legs[0];

        for (var i = 0; i < myRoute.steps.length; i++) {
            var marker = new google.maps.Marker({
                position: myRoute.steps[i].start_point,
                map: map
            });
            attachInstructionText(marker, myRoute.steps[i].instructions);
            markerArray[i] = marker;
        }
    }

    function attachInstructionText(marker, text) {
        google.maps.event.addListener(marker, 'click', function() {
            stepDisplay.setContent(text);
            stepDisplay.open(map, marker);
        });
    }

    google.maps.event.addDomListener(window, 'load', preinit);
    google.maps.event.addDomListener(window, 'load', initialize);

</script>

<style>
    .ui-panel-inner {
        overflow: scroll;
        -webkit-overflow-scrolling: touch;
    }

    .ui-panel.ui-panel-open {
        position:fixed;
    }

    #directions-panel {
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }

</style>



<div data-role="header" data-theme="b">
  <h1><%= @pharm.name %></h1>
  <%= link_to 'Back', pharms_path, 'data-icon' => 'back', 'class' => 'ui-btn-left' %>
  <%= link_to 'Edit', edit_pharm_path(@pharm), 'data-icon' => 'edit', 'class' => 'ui-btn-right', :target => '_parent' %>
</div>


<div data-role="content">

  <div class="ui-bar ui-bar-c ui-corner-all ui-shadow">
    <div id="map-canvas" style="width: 100%; height: 400px" class="ui-corner-all ui-shadow"></div>
  </div>

  <div class="ui-grid-a ui-responsive">
    <div class="ui-block-a">
      <a href="#popupMenu" data-rel="popup" data-role="button" data-transition="slideup" data-icon="gear" data-theme="b">Get Direction</a>
    </div>
    <div class="ui-block-b">
      <a href="#directions-panel" data-role="button" data-transition="slideup" data-icon="gear" data-theme="b">Panel</a>
    </div>
  </div>

  <div>
    <div data-role="popup" id="popupMenu">
      <a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>
      <ul data-role="listview" data-inset="true" style="min-width:210px;">
        <li><a href="" onclick="calcRoute('DRIVING');" data-rel="back">Driving</a></li>
        <li><a href="" onclick="calcRoute('WALKING');" data-rel="back">Walking</a></li>
        <li><a href="" onclick="calcRoute('BICYCLING');" data-rel="back">Bicycling</a></li>
      </ul>
    </div>
  </div>

  <!-- <div id="directions-panel"></div> -->

  <div data-role="panel" id="directions-panel" data-display="overlay" class="ui-responsive-panel"></div>

  <p>
    <strong>Address:</strong>
    <%= @pharm.address %>
  </p>
</div>